#深入Java虚拟机-读书笔记一Java运行时数据区域和对象创建和访问


##Java运行时数据区域
Java虚拟机在执行程序时把它所管理的内存划分为若干不同的数据区域。这些区域都有各自的用户，以及创建和销毁的时间。如下图
![avatar](/1.png)


###程序计数器
一块较小的内存空间，可以看作是当前线程所执行的字节码的行号指示器。由于Java虚拟机的多线程是通过线程轮流切换并分配处理器执行时间的方式来实现，在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要一个独立的计数器，因此属于线程私有的内存。<br>
如果线程正在执行一个Java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址，如果正在执行的是Native方法，这个计数器的值为空。
###Java虚拟机栈
也是线程私有的，生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法执行的同时都会创建一个栈帧用于存储局部变量表，操作数栈，动态链接，方法出口等信息。每个方法从调用值至执行完成的过程，就对应着一个栈帧在虚拟机中入栈和出栈的过程。
###本地方法栈
和Java虚拟机栈作用相似，为虚拟机使用的Native方法服务

###Java堆
堆是所有线程共享的一块内存区域。存放几乎所有对象的实例。几乎所有的对象实例以及数组都在堆上分配。
###方法区
各个线程共享的内存区域，用于存储以及被虚拟机加载的类信息，常量，静态变量，及时编译器编译后的代码等数据。
###运行时常量池
是方法区的一部分。Class文件中除了类的信息外，还有一项信息是常量池，用于存放编译期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放

##对象的创建
虚拟机遇到一条new指令时，首先会检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已被加载，解析，和初始化过。如果没有，则先执行类的加载过程。<br>类加载完成后，为对象在Java堆中分配一块内存。内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值。这步操作保证了对象的实例字段在Java代码中可以不赋初始值就直接使用。<br>操作完这步后，<init>方法还没有执行，所有的字段还为零。一般来说，执行new指令后会接着执行<init>方法，把对象按照程序员的意愿进行初始化
##对象的访问定位
创建对象后如何使用对象，我们的Java程序需要通过栈上的reference数据来操作堆上的具体对象，由于reference类型在虚拟机规范中只规定了一个指向对象的引用，因此如何访问堆中的对象的具体位置，也是取决于虚拟机实现而定.目前主流的访问方式有使用句柄和直接指针两种
>使用句柄，Java堆中划分一块内存来作为句柄池，reference中存储的就是对象的句柄地址，句柄中包含了对象的实例数据与类型数据各自的具体地址信息.

![avatar](/2.png)

>直接指针访问，那么Java堆对象的布局中就必须考虑如何放置访问类型数据的相关信息，而reference中存储的直接就是对象地址


![avatar](/3.png)


>**使用句柄来访问的最大好处就是reference中存储的是稳定的句柄地址，在对象被移动时（垃圾收集时移动对象是非常普遍的行为）只会改变句柄中的实例数据指针，而reference本身不需要修改<br>**


>**使用直接指针访问的最大好处就是速度更快，它节省了一个指针定位的时间开销，由于对象的访问在Java中非常频繁，因此这类开销成本也非常可观**